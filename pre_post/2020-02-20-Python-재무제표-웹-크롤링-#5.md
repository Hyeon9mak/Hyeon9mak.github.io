---
title: "[Python 재무제표 크롤링 #5] txt to tsv 자동화"
date: 2020-02-20 19:35:21
categories:
    - Python
tags:
    - Python
    - 파이썬
    - 재무제표
    - crolling
    - 크롤링
toc: true
toc_sticky: true
toc_label: "[Python 재무제표 크롤링 #5]"
---
OpenDART에서 제공해준 API들을 추가적으로 조사해보다가, 굳이 기업별로 재무정보를 확인할 필요 없이 
상장되어 있는 전체 기업들의 재무정보를 한꺼번에 확인할 수 있는 txt파일의 다운로드를 제공한다는 것을 확인했다.  
얼마전 차장님께서 진행해주신 ERP 관련 교육 때, ERP 내부 데이터베이스에 기업들의 재무정보를 기입해두면 
재무팀쪽에서 매번 번거롭게 DART 전자공시 사이트를 확인할 필요 없이 곧장 ERP 프로그램에서 확인할 수 있으므로 
큰 도움이 될거라고 말씀해주셨던 부분이 떠올라, 곧장 차장님께 해당 부분에 대해 보고를 드렸다.  
  
보고를 받으신 차장님께서 "해당 txt파일에 불필요한 컬럼들을 지우고, 추가로 몇 가지 컬럼을 기입해서
tsv파일로 변환할 수 있겠느냐" 라는 요청을 주셨고, 항상 일단 해보자라는 마인드인 나는 당연히 "해보겠습니다!" 라고 자신있게 대답을 드렸다.  
우렁찬 대답에 차장님께선 기뻐하셨지만, 전혀 생각해보지 않았던 영역을 시도해야했던 나는 똥줄이 타들어갔다!  
이래서 사람은 분수에 맞게 행동해야 하는건데... 나는 왜 알면서도 이렇게 욕심이 많을까...   
정말 다행스럽게도 크게 어려운 부분 없이 개발이 진행되었다.  

## 분석 및 설계
- OpenDART에서 제공되는 추가 API 확인
    - 기업별이 아닌 전체 기업 재무정보파일(.txt) 제공 API
    - 기업별 정보들이 엑셀의 컬럼 형식으로 정리되어 있음
    - 간격이 공백과 탭으로 뒤섞여 구분되어 있음
- 차장님께 보고후, 요청사항 전달 받음
    - 불필요한 정보 컬럼 제거
    - 추가 정보 컬럼 기입
    - 간격을 탭으로 통일
    - tsv 파일로 변환
- 이리이리이리ㅣ이해서 코드를 짰다~

## 작성 코드
```python
from urllib.request import urlopen    # for html request/respone
from bs4 import BeautifulSoup
import pandas as pd
import os
from selenium import webdriver

driver = webdriver.Chrome('chromedriver.exe')
driver.get("https://opendart.fss.or.kr/disclosureinfo/fnltt/dwld/main.do")
print(driver)
exit()
def download_files():
    XML_RESULT = BeautifulSoup(urlopen("https://opendart.fss.or.kr/disclosureinfo/fnltt/dwld/main.do").read(), 'html.parser')
    down_option = XML_RESULT.find_all('a', onclick=())
    print(XML_RESULT)
    exit()
    print(lambda x: "Y" if "\'FY\'," in x else "No.\n", down_option)
    exit()

def main() :
    download_files()

    CWD = os.getcwd()
    file_list = os.listdir(CWD)    # 현재 Python이 실행된 디렉토리 내부 파일들 가져오기
    dir_list = []
    for file in file_list :         # 현재 파일목록 탐색
        if "BS" in file or "PL" in file :   # 이름에 BS 또는 PL이 포함되는 경우
            if os.path.isdir(file) :        # BS 또는 PL에, 디렉토리인 경우
                dir_list.append(file)       # dir_list 에 추가

    for dir in dir_list :                   # dir_list 탐색
        fa_file_list = []                   # fa_file_list 초기화
        file_list = os.listdir(dir)         # dir 경로 내부 파일들 가져오기

        for file in file_list :             # dir 파일 목록 탐색
            if "사업보고서" in file :       # 이름에 사업보고서가 포함된 경우
                fa_file_list.append(file)   # fa_file_list 에 추가

        for fa_file in fa_file_list :       # fa_file_list 탐색
            TSV_TABLE = pd.read_csv(dir + "\\" + fa_file, sep="\t", encoding="cp949") #한글 인코딩, 탭단위 구분으로 읽어오기
            TSV_TABLE.rename(columns={"재무제표종류":"결산연도"}, inplace=True) # 재무제표종류 컬럼을 결산연도로 변경
            TSV_TABLE.rename(columns={"항목코드":"LEVEL"}, inplace=True)       # 항목코드 컬럼을 LEVEL로 변경
            TSV_TABLE.insert(loc=11, column="총계구분", value='')              # 총계구분 컬럼 추가
            del TSV_TABLE["업종"], TSV_TABLE["업종명"], TSV_TABLE["결산기준일"], TSV_TABLE["시장구분"]  
                                # 업종, 업종명, 결산기준일, 시장구분 컬럼 제거
            for del_unnamed in TSV_TABLE.columns :          # 공백으로 채워진 컬럼 제거
                if "Unnamed:" in del_unnamed : del TSV_TABLE[del_unnamed]

            TSV_TABLE["결산연도"] = fa_file[0:4]    # 결산연도 컬럼 값 채우기
            TSV_TABLE["LEVEL"] = list(map(lambda x: len(x) - len(x.lstrip()), TSV_TABLE["항목명"])) # LEVEL컬럼 값 채우기
            TSV_TABLE["총계구분"] = list(map(lambda x: "Y" if "총계" in x else "N", TSV_TABLE["항목명"])) #총계구분 컬럼 값 채우기   
            
            TSV_TABLE.to_csv("TSV___"+ fa_file.split('.')[0] + '.tsv', index=False, sep="\t")   # .tsv 파일로 저장
            TSV_TABLE.to_csv("TXT___"+ fa_file.split('.')[0] + '.txt', index=False, sep="\t")   # .txt 파일로 저장
            print(fa_file.split('.')[0] + "\t파일 변환 완료")   # 파일 당 성공여부 출력

main()
print("모든 TXT to TSV 변환이 완료되었습니다!") # 프로그램 정상종료 출력
```


## 결과화면

  
## 고찰 및 후기